<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¡œë˜ ë²ˆí˜¸ ì¶”ì²œ - Tê°€ ë§Œë“  Fë¥¼ ìœ„í•œ ë™ë¬¼ë³‘ì› ë¹„êµì•±</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
            color: #333;
        }
        
        /* ê³µí†µ ìŠ¤íƒ€ì¼  */
        p, h1, h2, h3, h4, span, div, td, label { word-break: keep-all; word-wrap: break-word; }
        #sidebar { transition: transform 0.3s ease-in-out; transform: translateX(-100%); }
        #sidebar.open { transform: translateX(0); }
        #sidebar-overlay { opacity: 0; transition: opacity 0.3s ease-in-out; pointer-events: none; }
        #sidebar-overlay.open { opacity: 1; pointer-events: auto; }
        .menu-item.active { background-color: #e0e7ff; color: #4f46e5; border-left: 4px solid #4f46e5; }

        /* ë¡œë˜ ê³µ ìŠ¤íƒ€ì¼ */
        .lotto-ball {
            width: 40px; height: 40px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            box-shadow: inset -2px -2px 6px rgba(0,0,0,0.2), 2px 2px 5px rgba(0,0,0,0.2);
        }
        .ball-yellow { background: #fbc400; }
        .ball-blue { background: #69c8f2; }
        .ball-red { background: #ff7272; }
        .ball-gray { background: #aaaaaa; }
        .ball-green { background: #b0d840; }
    </style>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        let db, auth, storage;
        let firebaseUid = null; 
        let displayUserId = sessionStorage.getItem('displayUserId') || null; 
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const FALLBACK_CONFIG = {
            apiKey: "AIzaSyBCXhv_eUpwU445W3eBdsYmGu_k1ZiMNB4",
            authDomain: "petvetshareapp.firebaseapp.com",
            databaseURL: "https://petvetshareapp-default-rtdb.firebaseio.com", 
            projectId: "petvetshareapp",
            storageBucket: "petvetshareapp.firebasestorage.app",
            messagingSenderId: "315370994100",
            appId: "1:315370994100:web:dad2415f70e4cbebc59ae1",
            measurementId: "G-P16N44NG95"
        };
        
        let firebaseConfig = FALLBACK_CONFIG;
        if (typeof __firebase_config !== 'undefined') {
            try { const envConfig = JSON.parse(__firebase_config); if (Object.keys(envConfig).length > 5) firebaseConfig = envConfig; } catch (e) {}
        }

        const COLLECTIONS = {
            LOTTO: `/artifacts/${appId}/public/data/lotto_predictions` // ë¡œë˜ ë°ì´í„° ê²½ë¡œ
        };

        function initializeFirebase() {
            try {
                if (Object.keys(firebaseConfig).length === 0) return; 
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                storage = getStorage(app); // ìŠ¤í† ë¦¬ì§€ ì´ˆê¸°í™”
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        firebaseUid = user.uid;
                    } else {
                        try { await signInAnonymously(auth); } catch(e) {}
                    }
                });
            } catch (error) { console.error("Firebase init error:", error); }
        }

        // --- ë¡œë˜ ê´€ë ¨ ë¡œì§ ---

        // ê³µ ìƒ‰ìƒ ê²°ì • í•¨ìˆ˜
        function getBallColorClass(num) {
            if (num <= 10) return 'ball-yellow';
            if (num <= 20) return 'ball-blue';
            if (num <= 30) return 'ball-red';
            if (num <= 40) return 'ball-gray';
            return 'ball-green';
        }

        // ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ë° ë Œë”ë§
        function setupDataListeners() {
            if (!db) { setTimeout(setupDataListeners, 100); return; }

            const q = query(collection(db, COLLECTIONS.LOTTO), orderBy("round", "desc"), limit(20));
            
            onSnapshot(q, (snapshot) => {
                const predictions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderMainPrediction(predictions[0]); // ê°€ì¥ ìµœì‹  íšŒì°¨
                renderHistory(predictions.slice(1));  // ì´ì „ íšŒì°¨ë“¤
            });
        }

        // ë©”ì¸(ìµœì‹ ) ì˜ˆì¸¡ ë Œë”ë§
        function renderMainPrediction(data) {
            const container = document.getElementById('latest-prediction-container');
            if (!data) {
                container.innerHTML = '<div class="text-center py-10 text-gray-500">ë°ì´í„° ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤...</div>';
                return;
            }

            const numbersHtml = data.numbers.map(n => 
                `<div class="lotto-ball ${getBallColorClass(n)} text-xl shadow-lg">${n}</div>`
            ).join('');

            container.innerHTML = `
                <div class="text-center">
                    <span class="bg-indigo-100 text-indigo-800 text-xs font-bold px-3 py-1 rounded-full mb-2 inline-block">Next Round</span>
                    <h2 class="text-4xl font-extrabold text-gray-900 mb-2">${data.round}íšŒì°¨ <span class="text-indigo-600">AI ì¶”ì²œë²ˆí˜¸</span></h2>
                    <p class="text-gray-500 text-sm mb-6">ë°œí‘œì¼: ${data.drawDate} (ì˜ˆì •)</p>
                    
                    <div class="flex justify-center gap-2 sm:gap-4 mb-8 flex-wrap">
                        ${numbersHtml}
                    </div>

                    <div class="bg-white rounded-xl border border-indigo-100 p-4 shadow-sm">
                        <h3 class="text-sm font-bold text-gray-700 mb-2">ğŸ“¢ AI ë¶„ì„ ì½”ë©˜íŠ¸</h3>
                        <p class="text-sm text-gray-600 leading-relaxed">
                            ${data.aiComment || "ìµœê·¼ 5ë…„ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ ë‹¹ì²¨ í™•ë¥ ì´ ê°€ì¥ ë†’ì€ ì¡°í•©ì„ ì‚°ì¶œí–ˆìŠµë‹ˆë‹¤."}
                        </p>
                    </div>
                </div>
            `;
        }

        // ì´ì „ ê¸°ë¡ ë Œë”ë§
        function renderHistory(list) {
            const container = document.getElementById('history-list');
            container.innerHTML = '';

            if (list.length === 0) {
                container.innerHTML = '<div class="text-center py-10 text-gray-400">ì´ì „ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            list.forEach(item => {
                const numbersHtml = item.numbers.map(n => 
                    `<div class="lotto-ball ${getBallColorClass(n)} w-6 h-6 text-xs mr-1">${n}</div>`
                ).join('');

                // ê²°ê³¼ ë±ƒì§€
                let resultBadge = '<span class="bg-gray-100 text-gray-500 text-xs px-2 py-1 rounded">ê²°ê³¼ ëŒ€ê¸°</span>';
                if (item.result === 'win') resultBadge = '<span class="bg-red-100 text-red-600 text-xs px-2 py-1 rounded font-bold">ğŸ‰ ë‹¹ì²¨</span>';
                else if (item.result === 'lose') resultBadge = '<span class="bg-gray-200 text-gray-500 text-xs px-2 py-1 rounded">ë‚™ì²¨</span>';

                // ì¸ì¦ìƒ· ë²„íŠ¼ ë˜ëŠ” ì´ë¯¸ì§€
                let verifyContent = '';
                if (item.verificationImage) {
                    verifyContent = `<div class="mt-2"><img src="${item.verificationImage}" class="h-20 w-auto rounded-lg border border-gray-200 cursor-pointer" onclick="window.open('${item.verificationImage}')" alt="ì¸ì¦ìƒ·"></div>`;
                } else {
                    verifyContent = `
                        <div class="mt-2">
                            <label class="cursor-pointer inline-flex items-center px-3 py-1.5 bg-white border border-gray-300 rounded-md font-semibold text-xs text-gray-700 hover:bg-gray-50 transition ease-in-out duration-150">
                                <svg class="w-4 h-4 mr-1 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                êµ¬ë§¤ ì¸ì¦ìƒ· ì˜¬ë¦¬ê¸°
                                <input type="file" class="hidden" accept="image/*" onchange="uploadVerification('${item.id}', this)">
                            </label>
                        </div>
                    `;
                }

                const card = document.createElement('div');
                card.className = 'bg-white p-5 rounded-xl shadow-sm border border-gray-100 mb-4';
                card.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <span class="font-bold text-lg text-gray-800">${item.round}íšŒì°¨</span>
                        ${resultBadge}
                    </div>
                    <div class="flex flex-wrap mb-3">
                        ${numbersHtml}
                    </div>
                    <div class="text-xs text-gray-400 mb-2">ì¶”ì²¨ì¼: ${item.drawDate}</div>
                    ${verifyContent}
                `;
                container.appendChild(card);
            });
        }

        // ì¸ì¦ìƒ· ì—…ë¡œë“œ í•¨ìˆ˜
        window.uploadVerification = async function(docId, input) {
            const file = input.files[0];
            if (!file) return;
            if (!firebaseUid) { alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); return; }

            const confirmUpload = confirm('ì´ ì‚¬ì§„ì„ êµ¬ë§¤ ì¸ì¦ìƒ·ìœ¼ë¡œ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
            if (!confirmUpload) return;

            // ë¡œë”© í‘œì‹œ (ê°„ë‹¨íˆ ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½ ë“±ìœ¼ë¡œ ì²˜ë¦¬ ê°€ëŠ¥í•˜ì§€ë§Œ ì—¬ê¸°ì„  alertë¡œ ëŒ€ì²´)
            alert('ì‚¬ì§„ì„ ì—…ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤...');

            try {
                // Firebase Storageì— ì—…ë¡œë“œ
                const storageRef = ref(storage, `lotto_verification/${docId}_${Date.now()}`);
                await uploadBytes(storageRef, file);
                const downloadURL = await getDownloadURL(storageRef);

                // Firestore ë¬¸ì„œ ì—…ë°ì´íŠ¸
                const docRef = doc(db, COLLECTIONS.LOTTO, docId);
                await updateDoc(docRef, {
                    verificationImage: downloadURL,
                    verifiedBy: displayUserId,
                    verifiedAt: new Date().toISOString()
                });

                alert('ì¸ì¦ìƒ·ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (error) {
                console.error("Upload failed:", error);
                alert('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
            }
        }

        // --- ê³µí†µ ê¸°ëŠ¥ (ë©”ë‰´ ë“±) ---
        function toggleMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            if (sidebar.classList.contains('open')) {
                sidebar.classList.remove('open'); overlay.classList.remove('open'); document.body.classList.remove('overflow-hidden');
            } else {
                sidebar.classList.add('open'); overlay.classList.add('open'); document.body.classList.add('overflow-hidden');
            }
        }
        window.toggleMenu = toggleMenu;
        window.closeMenu = function() {
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('sidebar-overlay').classList.remove('open');
            document.body.classList.remove('overflow-hidden');
        }
        window.handleLogout = function() { sessionStorage.removeItem('displayUserId'); window.location.href = 'login.html'; }

        function startApp() {
            if (!displayUserId) { window.location.href = 'login.html'; return; }
            if(document.getElementById('user-id-display-text')) document.getElementById('user-id-display-text').textContent = `${displayUserId} ë‹˜`; 
            
            // ë©”ë‰´ í™œì„±í™”
            document.querySelectorAll('.menu-item').forEach(item => {
                if(item.getAttribute('href') === 'lotto.html') item.classList.add('active');
            });

            setupDataListeners();
        }

        window.onload = () => {
            initializeFirebase();
            startApp();
            document.getElementById('menu-btn').addEventListener('click', window.toggleMenu);
            document.getElementById('sidebar-overlay').addEventListener('click', window.closeMenu);
        };
    </script>
</head>
<body class="min-h-screen">
    
    <div id="main-content" class="max-w-4xl mx-auto p-0 relative">
        
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40"></div>

        <aside id="sidebar" class="fixed top-0 left-0 w-64 h-full bg-white shadow-xl z-50 flex flex-col pt-16">
            <div class="p-4 border-b border-gray-200">
                <h3 class="text-xl font-bold text-gray-800 truncate">ì „ì²´ ë©”ë‰´</h3>
            </div>
            <nav class="flex-grow p-2 space-y-1">
                <a href="index.html" class="menu-item block px-4 py-3 text-gray-700 hover:bg-indigo-50 rounded-lg text-lg font-medium transition duration-150 truncate">ë©”ì¸</a>
                <a href="hospital_list.html" class="menu-item block px-4 py-3 text-gray-700 hover:bg-indigo-50 rounded-lg text-lg font-medium transition duration-150 truncate">ë³‘ì›ì •ë³´ ëª©ë¡</a>
                <a href="review_list.html" class="menu-item block px-4 py-3 text-gray-700 hover:bg-indigo-50 rounded-lg text-lg font-medium transition duration-150 truncate">ë¦¬ë·° ë¦¬ìŠ¤íŠ¸</a>
                <a href="free_board.html" class="menu-item block px-4 py-3 text-gray-700 hover:bg-indigo-50 rounded-lg text-lg font-medium transition duration-150 truncate">ë©ëƒ¥ ìˆ˜ë‹¤ë°©</a>
                <a href="lotto.html" class="menu-item active block px-4 py-3 text-gray-700 hover:bg-indigo-50 rounded-lg text-lg font-medium transition duration-150 truncate">ë¡œë˜ë²ˆí˜¸ì¶”ì²œ</a>
                <a href="store.html" class="menu-item block px-4 py-3 text-gray-700 hover:bg-indigo-50 rounded-lg text-lg font-medium transition duration-150 truncate">ìŠ¤í† ì–´</a>
            </nav>
            <div class="p-4 border-t border-gray-200 text-center">
                 <p class="text-sm text-gray-500">Version 1.0.0</p>
            </div>
        </aside>

        <nav class="sticky top-0 z-30 bg-white border-b border-gray-200 shadow-md p-3 w-full max-w-4xl mx-auto">
            <div class="flex items-center justify-between">
                <button id="menu-btn" class="text-gray-500 hover:text-indigo-600 p-2 rounded-lg transition duration-150 flex-shrink-0">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                </button>
                <a href="index.html" class="flex items-center justify-center flex-grow mx-2">
                    <img src="rexpawhosmain.png" alt="PET VET SHARE Logo" class="h-8 object-contain">
                </a>
                <div class="flex items-center space-x-2 flex-shrink-0">
                    <span id="user-id-display-text" class="text-sm font-semibold text-gray-600 truncate hidden sm:block"></span>
                    <button id="logout-btn" onclick="handleLogout()" class="text-sm font-semibold px-3 py-1 bg-red-500 text-white rounded-lg hover:bg-red-600 transition duration-150 shadow-sm">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </div>
        </nav>
        
        <div class="p-4 sm:p-6 lg:p-8">
            <!-- í—¤ë” -->
            <header class="bg-gradient-to-r from-purple-600 to-indigo-600 rounded-2xl shadow-xl p-6 mb-8 text-white relative overflow-hidden">
                <div class="relative z-10">
                    <h1 class="text-3xl sm:text-4xl font-extrabold tracking-tight mb-2 flex items-center">
                        ğŸ”® ë¡œë˜ ë²ˆí˜¸ AI ì¶”ì²œ
                    </h1>
                    <p class="text-indigo-100 text-sm sm:text-base leading-relaxed max-w-xl">
                        ìµœê·¼ 5ë…„ ë‹¹ì²¨ ë°ì´í„°ë¥¼ ì‹¤ì‹œê°„ ë¶„ì„!<br>
                        ì´ë²ˆ ì£¼ ê¸°ëŒ“ê°’ì´ ê°€ì¥ ë†’ì€ ë²ˆí˜¸ë¥¼ AIê°€ ì˜ˆì¸¡í•´ë“œë¦½ë‹ˆë‹¤.
                    </p>
                    <p class="text-xs text-yellow-300 mt-2 font-medium">
                        * ë§¤ì£¼ í† ìš”ì¼ ì €ë… 10ì‹œ ì—…ë°ì´íŠ¸
                    </p>
                </div>
                <div class="absolute top-0 right-0 -mr-10 -mt-10 w-40 h-40 bg-white opacity-10 rounded-full blur-2xl"></div>
            </header>
        
            <main>
                <!-- ë©”ì¸ ì¶”ì²œ ì˜ì—­ -->
                <div id="latest-prediction-container" class="bg-white p-8 rounded-2xl shadow-lg border-2 border-indigo-100 mb-8 transform transition hover:scale-[1.01]">
                    <div class="text-center py-10">
                        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600 mx-auto mb-4"></div>
                        <p class="text-gray-500">AIê°€ ë°ì´í„°ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p>
                    </div>
                </div>

                <!-- íˆìŠ¤í† ë¦¬ ì˜ì—­ -->
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    ğŸ“œ ì´ì „ íšŒì°¨ ì˜ˆì¸¡ ê²°ê³¼
                </h3>
                <div id="history-list" class="space-y-4">
                    <!-- ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œì´ ì—¬ê¸°ì— ë“¤ì–´ê°‘ë‹ˆë‹¤ -->
                </div>
            </main>
        </div>
    </div>

</body>
</html>